<!DOCTYPE html><html><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="description" content=""><meta name="viewport" content="width=device-width, initial-scale=1"><title>用 Docker 构建 NodeJS 应用 | Edward Chu's Blog</title><link rel="stylesheet" href="/assets/main.css"><script src="/assets/bundle.js"></script><script id="bdhm">var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?e18366090c703c986bb9172960f46513";
  hm.id = 'bdhm_js';
  hm.loaded = function(){
    delete window._bdhm_loaded_e18366090c703c986bb9172960f46513;
  }
  var s = document.getElementById('bdhm');
  s.parentNode.insertBefore(hm, s);
})();
</script><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');
ga('create', 'UA-57573368-1', 'auto');
ga('require', 'linkid', 'linkid.js');
ga('send', 'pageview');</script></head><body class="abs"><div class="leftbar"><div class="avatar card"><div class="sides"><div class="front"><a href="/" goback class="a-block"></a></div><div class="back invert"><div class="back-content"><a href="/" goback class="a-block"><div class="back-arrow"><span class="line top"></span><span class="line meat"></span><span class="line bottom"></span></div></a></div></div></div></div><div class="motto"><small>The Sensory World Is An Illusion.
<br>
原来心就是那个揣度者
</small></div><ul class="nav"><li class="nav-arrow"><a href="/" pjax>ARTICLES</a></li><li><a href="/archive.html" pjax>ARCHIVE</a></li><li><a href="/about.html" pjax>ABOUT</a></li></ul><div class="social"><span><a href="https://github.com/chuyik" target="_blank"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" x="0px" y="0px" viewBox="0 0 16 16" enable-background="new 0 0 16 16" xml:space="preserve" class="svg-icon"><path fill-rule="evenodd" clip-rule="evenodd" fill="#C2C2C2" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761           c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32           c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472           c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037           C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65           c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261           c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082           c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129           c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"></path></svg></a></span><span><a href="https://twitter.com/chuyiktong" target="_blank"><svg xmlns="http://www.w3.org/2000/svg" viewbox="0 0 2000 1625.36" version="1.1" class="svg-icon"><path d="m 1999.9999,192.4 c -73.58,32.64 -152.67,54.69 -235.66,64.61 84.7,-50.78 149.77,-131.19 180.41,-227.01 -79.29,47.03 -167.1,81.17 -260.57,99.57 C 1609.3399,49.82 1502.6999,0 1384.6799,0 c -226.6,0 -410.328,183.71 -410.328,410.31 0,32.16 3.628,63.48 10.625,93.51 -341.016,-17.11 -643.368,-180.47 -845.739,-428.72 -35.324,60.6 -55.5583,131.09 -55.5583,206.29 0,142.36 72.4373,267.95 182.5433,341.53 -67.262,-2.13 -130.535,-20.59 -185.8519,-51.32 -0.039,1.71 -0.039,3.42 -0.039,5.16 0,198.803 141.441,364.635 329.145,402.342 -34.426,9.375 -70.676,14.395 -108.098,14.395 -26.441,0 -52.145,-2.578 -77.203,-7.364 52.215,163.008 203.75,281.649 383.304,284.946 -140.429,110.062 -317.351,175.66 -509.5972,175.66 -33.1211,0 -65.7851,-1.949 -97.8828,-5.738 181.586,116.4176 397.27,184.359 628.988,184.359 754.732,0 1167.462,-625.238 1167.462,-1167.47 0,-17.79 -0.41,-35.48 -1.2,-53.08 80.1799,-57.86 149.7399,-130.12 204.7499,-212.41"></path></svg></a></span><span><a href="http://www.zhihu.com/people/edward-chu-68" target="_blank"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" x="0px" y="0px" width="82.5px" height="85px" viewBox="0 0 82.5 85" xml:space="preserve" class="svg-icon"><path d="M39.238,69.526c-0.156,0.573-0.261,0.312-1.458-1.042c-2.812-3.28-5.416-6.769-8.176-10.102  c-0.781-0.938-1.25-1.459-1.562-1.562l3.645-4.062c1.875,2.237,6.666,7.968,8.541,10.206C41.06,64.109,40.174,66.712,39.238,69.526  L39.238,69.526z M43.507,46.092c-2.812-0.053-7.655-0.053-10.415,0c-2.135,0-3.125,0.416-3.229,2.708  c-0.053,1.458-0.521,2.917-0.782,4.375l-1.77,5.833c-1.458,3.854-3.125,7.603-5.78,10.779c-2.656,3.176-6.301,3.592-10.051,3.749  c-0.573,0-1.406,0.106-1.614-0.676c-0.208-0.729,0.521-1.095,0.989-1.511c3.958-3.228,7.135-7.082,9.582-11.611  c1.978-3.646,3.176-7.552,3.802-11.667c0.261-1.769-0.365-2.134-2.031-2.081c-3.073,0.103-8.905-0.053-11.978,0  c-0.104,0,0.104-0.261,0.261-1.146c0.312-2.344,2.186-4.062,3.905-4.062c2.656,0.051,5.676-0.104,8.332,0  c1.718,0.051,2.447-0.782,2.395-2.553c-0.051-4.009,0.052-8.071,0.157-12.081c0.052-1.146-0.417-1.511-1.51-1.562  c-3.49-0.313-3.854-0.105-5.52,3.124c-1.354,2.656-4.166,4.167-6.979,4.843c-1.509,0.365-1.353,0.313-1.197-0.156  c2.24-5.312,4.687-12.134,6.771-17.498c0.885-2.187,4.582-3.801,6.717-5.051c0,0,0.521-0.364,0,1.146  c-0.521,1.666-1.197,4.687-1.823,6.301c-0.625,1.718-0.313,2.604,1.405,2.552c5.104-0.052,10.519,0,15.623,0  c1.198,0,2.241-0.208,2.968,1.093c2.449,4.219,1.927,3.489-0.468,3.541c-2.031,0.053-5.729,0.053-7.76,0  c-1.562-0.052-2.187,0.47-2.396,2.136c-0.416,4.114-0.104,8.228-0.469,12.29c-0.104,1.458,0.833,1.771,1.875,1.771  c2.656,0,4.634-0.053,7.291,0c2.188,0.052,3.28,2.603,3.645,4.687C43.56,46.145,44.133,46.092,43.507,46.092L43.507,46.092z   M60.692,67.964l-7.863,5.728l-1.51-5.728h-5.208V20.575h26.559v0.105v47.284H60.692L60.692,67.964z M67.462,25.262H51.319v38.014  h2.083l1.509,4.738l7.344-4.738h5.208V25.262L67.462,25.262z"></path></svg></a></span><span><a href="/feed.xml" target="_blank"><svg style="width: 85%" viewBox="0 0 33 33" width="25" height="25" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" class="svg-icon"><path d="M 4.259,23.467c-2.35,0-4.259,1.917-4.259,4.252c0,2.349, 1.909,4.244, 4.259,4.244 c 2.358,0, 4.265-1.895, 4.265-4.244C 8.525,25.383, 6.618,23.467, 4.259,23.467zM 0.005,10.873l0,6.133 c 3.993,0, 7.749,1.562, 10.577,4.391c 2.825,2.822, 4.384,6.595, 4.384,10.603l 6.16,0 C 21.125,20.349, 11.648,10.873, 0.005,10.873zM 0.012,0l0,6.136 c 14.243,0, 25.836,11.604, 25.836,25.864L 32,32 C 32,14.36, 17.648,0, 0.012,0z"></path></svg></a></span><span><a href="mailto:crazyzyt@gmail.com?subject=Hi :)" title="Drop me an email"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" x="0px" y="0px" viewBox="0 0 512 512" enable-background="new 0 0 512 512" xml:space="preserve" class="svg-icon"><path d="M49.744,103.407v305.186H50.1h411.156h1V103.407H49.744z M415.533,138.407L255.947,260.465 L96.473,138.407H415.533z M84.744,173.506l85.504,65.441L84.744,324.45V173.506z M85.1,373.593l113.186-113.186l57.654,44.127 l57.375-43.882l112.941,112.94H85.1z M427.256,325.097l-85.896-85.896l85.896-65.695V325.097z"></path></svg></a></span></div></div><div class="main"><div class="main-content"><article><!--<Header></Header>--><!----><header class="article-header"><h1><a href="/articles/docker-node-app.html" pjax-page>用 Docker 构建 NodeJS 应用</a></h1><time pubdate datetime="2014-12-30">2014-12-30</time></header><!--<Variables></Variables>--><!----><!--<Toc></Toc>--><!----><nav class="toc"><a href="#section0">Docker 入门</a><a href="#section1">下载并更新 Ubuntu 镜像</a><a href="#section2">从创建简单的 NodeJS 应用镜像入手</a><div><a href="#section3_0">目录结构</a><a href="#section3_1">文件创建步骤</a><a href="#section3_2">构建镜像</a><a href="#section3_3">运行镜像</a><a href="#section3_4">访问网页</a></div><a href="#section3">创建完整的 NodeJS 应用镜像（含 Mongodb / Git）</a><div><a href="#section4_0">目录结构</a><a href="#section4_1">文件创建步骤</a><a href="#section4_2">构建镜像</a><a href="#section4_3">运行镜像</a><a href="#section4_4">访问网页</a></div><a href="#section4">保存 Mongodb 数据文件</a><div><a href="#section5_0">磁盘映射</a><a href="#section5_1">Mac 的磁盘映射方案</a></div><a href="#section5">优化建议</a><div><a href="#section6_0">将 NodeJS 和 Mongodb 分开</a><a href="#section6_1">使用进程管理工具</a></div><a href="#section6">一些有用的 Docker 命令</a><div><a href="#section7_0">查看后台运行容器的日志</a><a href="#section7_1">开始和关闭容器的运行</a><a href="#section7_2">运行镜像的bash</a><a href="#section7_3">导入和导出镜像</a><a href="#section7_4">停止和删除所有容器</a></div><a href="#section7">参考文章 Credits</a></nav><!--<Pagination></Pagination>--><!----><!--<Article>Content</Article>--><!----><div class="article-content"><p><a href="http://www.docker.com/" target="_blank">Docker</a> 是个轻量级的虚拟化解决方案，可以将你的应用和所需的运行环境打包起来，部署至其他环境，保证开发或生产环境的统一。<br>对于开发人员来说，Docker 可以减少初次搭建开发环境的麻烦；<br>对于运维人员来说，Docker 使自动化、规模化部署变得更加简单。<br><!-- more --></p>
<h2 id="section0">Docker 入门</h2>
<p>本文不涉及太多的入门知识，假若你未曾听过 Docker，请先浏览官方资源：<br>1. 观看 Docker <a href="https://www.docker.com/whatisdocker/" target="_blank">介绍视频</a><br>2. 动手完成 10 分钟 <a href="https://www.docker.com/tryit/#" target="_blank">在线交互教程</a></p>
<h2 id="section1">下载并更新 Ubuntu 镜像</h2>
<p>本文中 NodeJS 应用是部署在 Ubuntu 下的，所以要先通过以下命令，下载 Ubuntu 镜像，并更新保存。</p>
<pre><code class="bash"><span class="hljs-comment"># 从 Docker Hub 下载官方维护的 Ubuntu</span>
docker pull ubuntu:<span class="hljs-number">14.10</span>

<span class="hljs-comment"># 下载完毕后，先更新软件源</span>
docker run ubuntu:<span class="hljs-number">14.10</span> apt-get update

<span class="hljs-comment"># 上面命令会生成一个container，先获得其 id</span>
<span class="hljs-comment"># -l：显示最新的 container</span>
doocker ps <span class="hljs-operator">-l</span>

<span class="hljs-comment"># 提交改动，并覆盖原有的 Ubuntu 镜像</span>
docker commit &lt;container_id&gt; ubuntu:<span class="hljs-number">14.10</span></code></pre>
<h2 id="section2">从创建简单的 NodeJS 应用镜像入手</h2>
<p>我们先来创建一个基于 ExpressJS 的简单 NodeJS 应用，以下是文件目录结构和步骤。</p>
<h3 id="section3_0">目录结构</h3>
<pre class="tree">
├── docker-node-hello/
│   ├── index.js
│   ├── package.json
│   ├── Dockerfile
</pre>

<h3 id="section3_1">文件创建步骤</h3>
<ol>
<li><p>创建文件夹</p>
<pre><code class="bash">mkdir ~/docker-node-hello &amp;&amp; <span class="hljs-built_in">cd</span> <span class="hljs-variable">$_</span></code></pre>
</li>
<li><p>创建 index.js</p>
<pre><code class="js"><span class="hljs-keyword">var</span> express = <span class="hljs-built_in">require</span>(<span class="hljs-string">'express'</span>)
<span class="hljs-keyword">var</span> app = express()

app.get(<span class="hljs-string">'/'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(req, res)</span> </span>{
 res.send(<span class="hljs-string">'Hello World!'</span>)
})

<span class="hljs-keyword">var</span> server = app.listen(<span class="hljs-number">3001</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{

 <span class="hljs-keyword">var</span> host = server.address().address
 <span class="hljs-keyword">var</span> port = server.address().port

 <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'Example app listening at http://%s:%s'</span>, host, port)

})</code></pre>
</li>
<li><p>创建 package.json</p>
<pre><code class="json">{
 "<span class="hljs-attribute">name</span>": <span class="hljs-value"><span class="hljs-string">"docker-node-hello"</span></span>,
 "<span class="hljs-attribute">private</span>": <span class="hljs-value"><span class="hljs-literal">true</span></span>,
 "<span class="hljs-attribute">version</span>": <span class="hljs-value"><span class="hljs-string">"0.0.1"</span></span>,
 "<span class="hljs-attribute">description</span>": <span class="hljs-value"><span class="hljs-string">"Node.js Hello world app on Ubuntu using docker"</span></span>,
 "<span class="hljs-attribute">dependencies</span>": <span class="hljs-value">{
   "<span class="hljs-attribute">express</span>": <span class="hljs-value"><span class="hljs-string">"4.x.x"</span>
 </span>}
</span>}</code></pre>
</li>
<li><p>创建 Dockerfile 配置文件</p>
<pre><code class="bash"><span class="hljs-comment"># 设置基础镜像</span>
FROM ubuntu:<span class="hljs-number">14.10</span>

<span class="hljs-comment"># 如果上个步骤已经更新软件源，这步可以忽略</span>
RUN apt-get update

<span class="hljs-comment"># 安装 NodeJS 和 npm</span>
RUN apt-get install -y nodejs npm

<span class="hljs-comment"># 将目录中的文件添加至镜像的 /srv/hello 目录中</span>
ADD . /srv/hello

<span class="hljs-comment"># 设置工作目录</span>
WORKDIR /srv/hello

<span class="hljs-comment"># 安装 Node 依赖库</span>
RUN npm install

<span class="hljs-comment"># 暴露 3001 端口，便于访问</span>
EXPOSE <span class="hljs-number">3001</span>

<span class="hljs-comment"># 设置启动时默认运行命令</span>
CMD [<span class="hljs-string">"nodejs”, “/srv/hello/index"</span>]</code></pre>
</li>
</ol>
<h3 id="section3_2">构建镜像</h3>
<pre><code class="bash">  <span class="hljs-comment"># 通过该命令，按照 Dockerfile 所配置的信息构建出镜像</span>
  <span class="hljs-comment"># -t 镜像的名称</span>
  <span class="hljs-comment"># --rm 构建成功后，删除临时镜像（每执行一行 Dockerfile 中的命令，就会创建一个临时镜像）</span>
  docker build --rm -t node-hello .

  <span class="hljs-comment"># 检查镜像是否创建成功</span>
  docker images</code></pre>
<h3 id="section3_3">运行镜像</h3>
<pre><code class="bash">  <span class="hljs-comment"># 对于 Mac 或 Windows 来说，要先查看 boot2docker 的 IP</span>
  boot2docker ip

  <span class="hljs-comment"># 运行刚刚创建的镜像</span>
  <span class="hljs-comment"># -p 设置端口，格式为「主机端口:容器端口」</span>
  docker run -p <span class="hljs-number">3001</span>:<span class="hljs-number">3001</span> node-hello</code></pre>
<h3 id="section3_4">访问网页</h3>
<p>若终端打印出 <code>Example app listening at http://...</code>，则部署成功。<br>可以用浏览器访问 <code>http://&lt;boot2docker ip&gt;:3001</code>，或运行 <code>curl -s &quot;$(boot2docker ip):3001&quot;</code>。</p>
<h2 id="section3">创建完整的 NodeJS 应用镜像（含 Mongodb / Git）</h2>
<p>通过上面的例子，我们知道了整个 Docker 镜像的基本创建过程。<br>但实际项目中，项目代码往往是通过 Git 来管理的，而且还会连接到一些数据库，如 Mongodb。<br>本例子中，我们将尝试部署一个 MEAN 架构的 NodeJS 应用。</p>
<blockquote>
<p>什么是 MEAN 架构？<br>MEAN 表示 Mongodb / ExpressJS / AngularJS / NodeJS，是目前流行的网站应用开发组合，涵盖前端至后台。由于这些框架用的语言都是 Javascript，所以又戏称 Javascript Fullstack。</p>
</blockquote>
<h3 id="section4_0">目录结构</h3>
<pre class="tree">
├── docker-node-full/
│   ├── start.sh
│   ├── Dockerfile
</pre>

<h3 id="section4_1">文件创建步骤</h3>
<ol>
<li><p>创建文件夹</p>
<pre><code class="bash">mkdir ~/docker-node-full &amp;&amp; <span class="hljs-built_in">cd</span> <span class="hljs-variable">$_</span></code></pre>
</li>
<li><p>创建 Dockerfile 配置文件</p>
<pre><code class="bash"><span class="hljs-comment"># 设置基础镜像</span>
FROM ubuntu:<span class="hljs-number">14.10</span>

<span class="hljs-comment"># 安装 NodeJS 和 npm</span>
RUN apt-get install -y nodejs npm

<span class="hljs-comment"># 由于 apt-get 下载的 Node 实际上是 nodejs，所以要创建一个 node 的快捷方式</span>
RUN ln <span class="hljs-operator">-s</span> /usr/bin/nodejs /usr/bin/node

<span class="hljs-comment"># 安装 Git</span>
RUN apt-get install -y git

<span class="hljs-comment"># 安装 Mongodb（来自官方教程）</span>
RUN apt-key adv --keyserver hkp://keyserver.ubuntu.com:<span class="hljs-number">80</span> --recv <span class="hljs-number">7</span>F0CEB10
RUN <span class="hljs-built_in">echo</span> <span class="hljs-string">'deb http://downloads-distro.mongodb.org/repo/ubuntu-upstart dist 10gen'</span> | tee /etc/apt/sources.list.d/mongodb.list
RUN apt-get update
RUN apt-get install -y mongodb-org

<span class="hljs-comment"># 设置工作目录</span>
WORKDIR /srv/full

<span class="hljs-comment"># 清空已存在的文件（如果有）</span>
RUN rm -rf /srv/full

<span class="hljs-comment"># 通过 Git 下载准备好的 MEAN 架构的网站代码</span>
RUN git <span class="hljs-built_in">clone</span> https://github.com/chuyik/fullstack-demo-dist.git .

<span class="hljs-comment"># 安装 NodeJS 依赖库</span>
RUN npm install --production

<span class="hljs-comment"># 创建 mongodb 数据文件夹</span>
RUN mkdir -p /data/db

<span class="hljs-comment"># 暴露端口（分别是 NodeJS 应用和 Mongodb）</span>
EXPOSE <span class="hljs-number">5566</span> <span class="hljs-number">27017</span>

<span class="hljs-comment"># 设置 NodeJS 应用环境变量</span>
ENV NODE_ENV=production PORT=<span class="hljs-number">5566</span>

<span class="hljs-comment"># 添加启动脚本</span>
ADD start.sh /tmp/
RUN chmod +x /tmp/start.sh

<span class="hljs-comment"># 设置启动时默认运行命令</span>
CMD [<span class="hljs-string">"bash"</span>, <span class="hljs-string">"/tmp/start.sh"</span>]</code></pre>
</li>
<li><p>创建 start.sh 启动脚本</p>
<pre><code class="bash"><span class="hljs-comment"># 后台启动 Mongodb</span>
mongod --fork --logpath=/var/<span class="hljs-built_in">log</span>/mongo.log --logappend

<span class="hljs-comment"># 运行 NodeJS 应用</span>
npm start</code></pre>
</li>
</ol>
<h3 id="section4_2">构建镜像</h3>
<pre><code class="bash">  <span class="hljs-comment"># 通过该命令，按照 Dockerfile 所配置的信息构建出镜像</span>
  docker build --rm -t node-full .

  <span class="hljs-comment"># 检查镜像是否创建成功</span>
  docker images</code></pre>
<h3 id="section4_3">运行镜像</h3>
<pre><code class="bash">  <span class="hljs-comment"># 对于 Mac 或 Windows 来说，要先查看 boot2docker 的 IP</span>
  boot2docker ip

  <span class="hljs-comment"># 运行刚刚创建的镜像</span>
  <span class="hljs-comment"># -p 设置端口，格式为「主机端口:容器端口」</span>
  docker run -p <span class="hljs-number">5566</span>:<span class="hljs-number">5566</span> node-full</code></pre>
<h3 id="section4_4">访问网页</h3>
<p>若终端打印出以下命令，则部署成功。</p>
<blockquote>
<p> about to fork child process, waiting until server is ready for connections.<br>    forked process: 9<br>  child process started successfully, parent exiting<br> demo@0.0.0 start /srv<br> node server/app.js<br>  Express server listening on 5566, in production mode</p>
</blockquote>
<p>可以用浏览器访问 <code>http://&lt;boot2docker ip&gt;:5566</code>，或运行 <code>curl -s &quot;$(boot2docker ip):5566&quot;</code>。</p>
<h2 id="section4">保存 Mongodb 数据文件</h2>
<p>由于 Mongodb 服务运行在 Docker 容器 (container) 中，所以数据也在里面，但这并不利于数据管理和保存。因此，可以通过一些方法，将 Mongodb 数据文件保存在容器的外头。</p>
<h3 id="section5_0">磁盘映射</h3>
<p>这个是最简单的方式，在 <code>docker run</code> 命令当中，就有磁盘映射的参数 <code>-v</code>。</p>
<pre><code class="bash"><span class="hljs-comment"># -v 磁盘映射，格式为「主机目录:容器目录」</span>
docker run -p <span class="hljs-number">5566</span>:<span class="hljs-number">5566</span> -v /var/mongodata:/data/db node-full</code></pre>
<p>但这个命令在 Mac 和 Windows 中执行失败，因为 boot2docker 的虚拟机不支持。<br>所以，可以将数据保存在 boot2docker 内，并设置共享文件夹便于 Mac 或 Windows 访问。</p>
<h3 id="section5_1">Mac 的磁盘映射方案</h3>
<pre><code class="bash"><span class="hljs-comment"># 在 boot2docker 中，运行该命令</span>
boot2docker ssh
<span class="hljs-comment"># 进入 bash 后，创建存放 Mongodb 数据库文件的目录</span>
sudo mkdir -p /mnt/sda1/dev

<span class="hljs-comment"># Mac 用户通过 brew 安装 sshfs</span>
brew install sshfs
<span class="hljs-comment"># 通过 sshfs，把 /mnt/sda1/dev 挂载到 Mac 中</span>
<span class="hljs-comment"># 注：boot2docker 的默认用户为 docker/tcuser</span>
<span class="hljs-built_in">echo</span> tcuser | sshfs docker@localhost:/mnt/sda1/dev /var/mongodata -p <span class="hljs-number">2022</span> -o password_stdin

<span class="hljs-comment"># 运行镜像测试（映射 boot2docker 的目录）</span>
docker run -p <span class="hljs-number">5566</span>:<span class="hljs-number">5566</span> -v /mnt/sda1/dev:/data/db node-full</code></pre>
<h2 id="section5">优化建议</h2>
<h3 id="section6_0">将 NodeJS 和 Mongodb 分开</h3>
<p>上个例子中，我们把 NodeJS 和 Mongodb 放进了同一个镜像中，但本着一次只做一件事的原则，将其放进不同的镜像可能会更好。但分开后，NodeJS 和 Mongodb 运行的容器该如何关联呢？这里不展开介绍，有兴趣可以查阅该<a href="http://www.luiselizondo.net/how-to-create-a-docker-node-js-mongodb-varnish-environment/" target="_blank">博文</a>。</p>
<h3 id="section6_1">使用进程管理工具</h3>
<p>上个例子中，我们通过 bash 脚本来运行多个命令，但也可以用一些进程管理工具来配置进程，如 <a href="http://supervisord.org/introduction.html" target="_blank">Supervisor</a>。整合的方式可以查阅官方教程 <a href="https://docs.docker.com/articles/using_supervisord/" target="_blank">Using Supervisor with Docker</a>。</p>
<h2 id="section6">一些有用的 Docker 命令</h2>
<h3 id="section7_0">查看后台运行容器的日志</h3>
<pre><code class="bash">docker ps <span class="hljs-operator">-l</span>
docker logs &lt;container_id&gt;</code></pre>
<h3 id="section7_1">开始和关闭容器的运行</h3>
<pre><code class="bash">docker stop &lt;container_id&gt;
docker start -i &lt;container_id&gt;
docker restart -i &lt;container_id&gt;</code></pre>
<h3 id="section7_2">运行镜像的bash</h3>
<pre><code class="bash"><span class="hljs-comment"># -i 将命令的输出信息重定向到 stdout</span>
<span class="hljs-comment"># -t 开启 tty 终端，这样就能够输入指令</span>
docker run -it ubuntu:<span class="hljs-number">14.10</span> bash</code></pre>
<h3 id="section7_3">导入和导出镜像</h3>
<pre><code class="bash">docker save ubuntu:<span class="hljs-number">14.10</span> &gt; ubuntu_14.<span class="hljs-number">10</span>.tar
sudo docker ubuntu:<span class="hljs-number">14.10</span> &lt; ubuntu_14.<span class="hljs-number">10</span>.tar</code></pre>
<h3 id="section7_4">停止和删除所有容器</h3>
<blockquote>
<p>来自 <a href="https://coderwall.com/p/ewk0mq/stop-remove-all-docker-containers" target="_blank">Fabio Rehm</a></p>
</blockquote>
<pre><code class="bash">docker stop $(docker ps <span class="hljs-operator">-a</span> -q)
docker rm $(docker ps <span class="hljs-operator">-a</span> -q)</code></pre>
<h2 id="section7">参考文章 Credits</h2>
<p><a href="https://docs.docker.com/examples/nodejs_web_app/" target="_blank">Dockerizing a Node.js Web App</a><br><a href="http://tech.uc.cn/?p=2726" target="_blank">利用Docker构建开发环境 | UC技术博客</a><br><a href="http://docs.docker.com/reference/builder" target="_blank">Dockerfile - Docker Documentation</a><br><a href="http://docs.docker.com/reference/commandline/cli/" target="_blank">Command line - Docker Documentation</a><br><a href="https://docs.docker.com/articles/using_supervisord/" target="_blank">Using Supervisor - Docker Documentation</a><br><a href="http://www.luiselizondo.net/how-to-create-a-docker-node-js-mongodb-varnish-environment/" target="_blank">How to create a Docker + Node.js + MongoDB + Varnish environment</a><br><a href="https://gist.github.com/codeinthehole/7ea69f8a21c67cc07293" target="_blank">How to share folders with docker containers on OSX</a></p>
</div><!--<Footer></Footer>--><!----><footer><div class="license"><span><a style="color: #444" href="https://creativecommons.org/licenses/by-nc-sa/3.0/cn/" target="_blank">CC BY-NC-SA 3.0 License</a></span></div></footer><!--<Inline>Function</Inline>--><!----></article></div></div><div class="footer"><div class="back-to-top footer-float-btn">^</div><div><a style="color: #AAA;" title="View Source Code" href="https://github.com/chuyik/chuyik.github.io/tree/harp" target="_blank">IMAO I design it myself.</a><div style="margin:0 0 5px 0"><small style="color: #CCC;">Powered by<a style="color: #CCC; padding: 0 0 0 3px" href="http://harpjs.com" target="_blank">Harp</a></small></div></div></div></body></html>